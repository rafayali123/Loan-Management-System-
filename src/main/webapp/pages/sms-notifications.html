<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Notifications - Loan Management System</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/responsive.css">
    <style>
        .notification-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .notification-form {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: #2563eb;
            margin-bottom: 15px;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-column: 1 / -1;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .message-counter {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-send {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-send:active {
            transform: translateY(0);
        }

        .btn-send:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-reset {
            background: #e5e7eb;
            color: #1f2937;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-reset:hover {
            background: #d1d5db;
        }

        .notification-status {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .notification-status.success {
            background-color: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
            display: block;
        }

        .notification-status.error {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
            display: block;
        }

        .notification-status.info {
            background-color: #dbeafe;
            color: #0c4a6e;
            border-left: 4px solid #0ea5e9;
            display: block;
        }

        .sms-preview {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .sms-preview-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .sms-preview-content {
            background: white;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid #2563eb;
            font-size: 14px;
            line-height: 1.5;
            color: #1f2937;
        }

        .phone-input-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .template-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 13px;
        }

        .template-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .template-btn strong {
            display: block;
            margin-bottom: 5px;
            color: #1f2937;
        }

        @media (max-width: 768px) {
            .notification-container {
                padding: 10px;
            }

            .notification-form {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .templates {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="notification-container">
        <div class="notification-form">
            <h2 style="color: #2563eb; margin-bottom: 30px;">ðŸ“± SMS Notification System</h2>

            <div id="statusMessage" class="notification-status"></div>

            <!-- Quick Templates -->
            <div class="form-section">
                <h3>Quick Message Templates</h3>
                <div class="templates">
                    <button class="template-btn" onclick="useTemplate('registration')">
                        <strong>Registration</strong>
                        <span>Welcome user</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('loanApproval')">
                        <strong>Loan Approval</strong>
                        <span>Loan approved</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('loanRejection')">
                        <strong>Loan Rejection</strong>
                        <span>Application rejected</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('reminder')">
                        <strong>Payment Reminder</strong>
                        <span>EMI due notice</span>
                    </button>
                </div>
            </div>

            <!-- Send Custom SMS -->
            <form id="smsForm" onsubmit="sendSMS(event)">
                <div class="form-section">
                    <h3>Send Custom SMS</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number <span style="color: #ef4444;">*</span></label>
                            <input 
                                type="tel" 
                                id="phoneNumber" 
                                name="phoneNumber"
                                placeholder="+91 9876543210 or 9876543210"
                                required
                            >
                            <div class="phone-input-hint">Format: +91XXXXXXXXXX or 10-digit number</div>
                        </div>

                        <div class="form-group">
                            <label for="smsType">Message Type</label>
                            <select id="smsType" onchange="updatePreview()">
                                <option value="custom">Custom Message</option>
                                <option value="registration">Registration Confirmation</option>
                                <option value="loanApproval">Loan Approval</option>
                                <option value="loanRejection">Loan Rejection</option>
                                <option value="paymentReminder">Payment Reminder</option>
                                <option value="paymentConfirmation">Payment Confirmation</option>
                            </select>
                        </div>
                    </div>

                    <div id="customFields" class="form-row full">
                        <div class="form-group">
                            <label for="message">Message <span style="color: #ef4444;">*</span></label>
                            <textarea 
                                id="message" 
                                name="message"
                                placeholder="Enter your SMS message here..."
                                required
                                onchange="updatePreview()"
                                oninput="updateCharCount()"
                            ></textarea>
                            <div class="message-counter">
                                Characters: <span id="charCount">0</span>/160
                            </div>
                        </div>
                    </div>

                    <div id="optionalFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="userName">User Name (Optional)</label>
                                <input 
                                    type="text" 
                                    id="userName" 
                                    placeholder="e.g., John Doe"
                                >
                            </div>

                            <div class="form-group">
                                <label for="loanAmount">Loan Amount (Optional)</label>
                                <input 
                                    type="text" 
                                    id="loanAmount" 
                                    placeholder="e.g., â‚¹50,000"
                                >
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="dueDate">Due Date (Optional)</label>
                                <input 
                                    type="date" 
                                    id="dueDate"
                                >
                            </div>

                            <div class="form-group">
                                <label for="refId">Reference ID (Optional)</label>
                                <input 
                                    type="text" 
                                    id="refId" 
                                    placeholder="e.g., LOAN-2026-001"
                                >
                            </div>
                        </div>
                    </div>

                    <!-- SMS Preview -->
                    <div class="sms-preview">
                        <div class="sms-preview-title">ðŸ“¨ SMS Preview</div>
                        <div class="sms-preview-content" id="smsPreview">
                            Your SMS message will appear here...
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="button-group">
                        <button type="submit" class="btn-send" id="sendBtn">
                            <span id="sendBtnText">Send SMS</span>
                        </button>
                        <button type="reset" class="btn-reset" onclick="resetForm()">Clear</button>
                    </div>
                </div>
            </form>

            <!-- Send to Multiple Users -->
            <div class="form-section" style="margin-top: 40px; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                <h3>Send Broadcast Message</h3>
                <p style="color: #6b7280; margin-bottom: 15px;">Send the same message to multiple phone numbers</p>
                
                <form id="broadcastForm" onsubmit="sendBroadcast(event)">
                    <div class="form-row full">
                        <div class="form-group">
                            <label for="phoneNumbers">Phone Numbers (one per line) <span style="color: #ef4444;">*</span></label>
                            <textarea 
                                id="phoneNumbers" 
                                placeholder="+91 9876543210&#10;+91 9876543211&#10;+91 9876543212"
                                style="min-height: 120px;"
                                required
                            ></textarea>
                            <div class="phone-input-hint">Enter each phone number on a new line</div>
                        </div>
                    </div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label for="broadcastMessage">Message <span style="color: #ef4444;">*</span></label>
                            <textarea 
                                id="broadcastMessage" 
                                placeholder="Enter message to send to all..."
                                style="min-height: 100px;"
                                required
                            ></textarea>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn-send" id="broadcastBtn">
                            Send to All
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // Message templates
        const templates = {
            registration: {
                message: 'Welcome! Your account has been successfully registered in our Loan Management System. You can now login with your credentials. Thank you!'
            },
            loanApproval: {
                message: 'Dear [Name], Your loan application for â‚¹[Amount] has been APPROVED. Please contact our office for next steps. Thank you!'
            },
            loanRejection: {
                message: 'Dear [Name], We regret to inform that your loan application (ID: [RefID]) has been REJECTED. Please contact our office for details. Thank you!'
            },
            reminder: {
                message: 'Dear [Name], This is a reminder that your loan installment of â‚¹[Amount] is due on [Date]. Please ensure timely payment. Thank you!'
            }
        };

        // Use template
        function useTemplate(templateName) {
            const template = templates[templateName];
            if (template) {
                document.getElementById('message').value = template.message;
                document.getElementById('smsType').value = templateName;
                updatePreview();
                document.getElementById('message').focus();
            }
        }

        // Update character count
        function updateCharCount() {
            const message = document.getElementById('message').value;
            document.getElementById('charCount').textContent = message.length;
            
            // Show warning if SMS exceeds 160 characters
            if (message.length > 160) {
                document.getElementById('charCount').style.color = '#ef4444';
            } else {
                document.getElementById('charCount').style.color = '#6b7280';
            }
        }

        // Update preview
        function updatePreview() {
            const message = document.getElementById('message').value || 'Your SMS message will appear here...';
            document.getElementById('smsPreview').textContent = message;
            updateCharCount();
        }

        // Reset form
        function resetForm() {
            document.getElementById('smsForm').reset();
            document.getElementById('message').value = '';
            document.getElementById('smsPreview').textContent = 'Your SMS message will appear here...';
            document.getElementById('charCount').textContent = '0';
            hideStatus();
        }

        // Send SMS
        async function sendSMS(event) {
            event.preventDefault();

            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const message = document.getElementById('message').value.trim();
            const sendBtn = document.getElementById('sendBtn');
            const sendBtnText = document.getElementById('sendBtnText');

            if (!phoneNumber || !message) {
                showStatus('Please fill all required fields', 'error');
                return;
            }

            sendBtn.disabled = true;
            sendBtnText.textContent = 'Sending...';

            try {
                const response = await fetch(`${API_BASE}/sms/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        message: message
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('âœ“ SMS sent successfully to ' + phoneNumber, 'success');
                    resetForm();
                } else {
                    showStatus('Error: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('Network error. Please try again.', 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtnText.textContent = 'Send SMS';
            }
        }

        // Send broadcast
        async function sendBroadcast(event) {
            event.preventDefault();

            const phoneNumbersText = document.getElementById('phoneNumbers').value.trim();
            const message = document.getElementById('broadcastMessage').value.trim();
            const broadcastBtn = document.getElementById('broadcastBtn');

            if (!phoneNumbersText || !message) {
                showStatus('Please fill all required fields', 'error');
                return;
            }

            const phoneNumbers = phoneNumbersText.split('\n')
                .map(p => p.trim())
                .filter(p => p.length > 0);

            if (phoneNumbers.length === 0) {
                showStatus('Please enter at least one phone number', 'error');
                return;
            }

            broadcastBtn.disabled = true;
            broadcastBtn.textContent = 'Sending...';

            let successCount = 0;
            let errorCount = 0;

            for (const phoneNumber of phoneNumbers) {
                try {
                    const response = await fetch(`${API_BASE}/sms/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phoneNumber: phoneNumber,
                            message: message
                        })
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            const total = phoneNumbers.length;
            const statusMsg = `âœ“ Broadcast complete: ${successCount}/${total} sent successfully${errorCount > 0 ? `, ${errorCount} failed` : ''}`;
            showStatus(statusMsg, 'success');

            broadcastBtn.disabled = false;
            broadcastBtn.textContent = 'Send to All';
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'notification-status ' + type;
            statusDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Hide status message
        function hideStatus() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'notification-status';
            statusDiv.textContent = '';
        }

        // Initialize preview
        updatePreview();
    </script>
</body>
</html>
